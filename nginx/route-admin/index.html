<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nginx 动态路由管理</title>
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <!-- Dark Mode CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/theme-chalk/dark/css-vars.css">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: #e5eaf3;
        }
        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .el-container {
            height: 100%;
        }
        .el-header {
            background-color: #1e1e20;
            border-bottom: 1px solid #363637;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            height: 60px;
        }
        .logo {
            font-size: 1.2rem;
            font-weight: 600;
            color: #409eff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .el-aside {
            background-color: #1e1e20;
            border-right: 1px solid #363637;
            transition: width 0.3s;
        }
        .el-main {
            background-color: #141414;
            padding: 20px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .mb-4 { margin-bottom: 1rem; }
        .w-full { width: 100%; }
        
        /* Mobile Adaptations */
        @media (max-width: 768px) {
            .el-aside {
                display: none;
            }
            .el-header {
                padding: 0 10px;
            }
            .logo span {
                display: none;
            }
            .el-main {
                padding: 10px;
            }
            .mobile-menu-btn {
                display: inline-flex !important;
            }
        }
        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none !important;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #363637; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4c4c4d; 
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #141414;
        }
        .login-card {
            width: 100%;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login View -->
        <div v-if="!isAuthenticated" class="login-container">
            <el-card class="login-card">
                <template #header>
                    <div style="text-align: center; font-size: 1.2rem; font-weight: 600; color: #409eff;">
                        <el-icon style="vertical-align: middle; margin-right: 8px;"><Lock /></el-icon>
                        管理员登录
                    </div>
                </template>
                <el-form @submit.prevent="login">
                    <el-form-item>
                        <el-input v-model="password" type="password" placeholder="请输入管理员密码" show-password prefix-icon="Key" @keyup.enter="login"></el-input>
                    </el-form-item>
                    <el-button type="primary" class="w-full" @click="login" :loading="loading">登录</el-button>
                </el-form>
            </el-card>
        </div>

        <!-- Main App View -->
        <el-container v-else>
            <el-header>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <el-button class="mobile-menu-btn" icon="Menu" circle @click="drawerVisible = true"></el-button>
                    <div class="logo">
                        <el-icon><Connection /></el-icon>
                        <span>Nginx 路由管理</span>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <el-tag v-if="syncStatus.stage === 'complete'" type="success" effect="dark" size="small">同步完成</el-tag>
                    <el-tag v-else type="warning" effect="dark" size="small">同步中 {{ syncStatus.progress }}%</el-tag>
                    <el-button type="danger" link icon="SwitchButton" @click="logout">退出</el-button>
                </div>
            </el-header>
            <el-container>
                <!-- Desktop Sidebar -->
                <el-aside width="220px">
                    <el-menu
                        :default-active="currentView"
                        background-color="#1e1e20"
                        text-color="#fff"
                        active-text-color="#409eff"
                        style="border-right: none;"
                        @select="handleMenuSelect">
                        <el-menu-item index="1">
                            <el-icon><Odometer /></el-icon>
                            <span>概览 & 基础</span>
                        </el-menu-item>
                        <el-menu-item index="2">
                            <el-icon><Operation /></el-icon>
                            <span>高级规则</span>
                        </el-menu-item>
                        <el-menu-item index="3">
                            <el-icon><Tools /></el-icon>
                            <span>规则测试</span>
                        </el-menu-item>
                        <el-menu-item index="4">
                            <el-icon><Setting /></el-icon>
                            <span>系统设置</span>
                        </el-menu-item>
                    </el-menu>
                </el-aside>

                <!-- Mobile Drawer Menu -->
                <el-drawer
                    v-model="drawerVisible"
                    title="菜单"
                    direction="ltr"
                    size="240px"
                    :with-header="false">
                    <div style="padding: 20px; font-size: 1.2rem; font-weight: 600; color: #409eff; display: flex; align-items: center; gap: 10px;">
                        <el-icon><Connection /></el-icon> Nginx 路由
                    </div>
                    <el-menu
                        :default-active="currentView"
                        background-color="transparent"
                        text-color="#fff"
                        active-text-color="#409eff"
                        style="border-right: none;"
                        @select="handleMenuSelect">
                        <el-menu-item index="1">
                            <el-icon><Odometer /></el-icon>
                            <span>概览 & 基础</span>
                        </el-menu-item>
                        <el-menu-item index="2">
                            <el-icon><Operation /></el-icon>
                            <span>高级规则</span>
                        </el-menu-item>
                        <el-menu-item index="3">
                            <el-icon><Tools /></el-icon>
                            <span>规则测试</span>
                        </el-menu-item>
                        <el-menu-item index="4">
                            <el-icon><Setting /></el-icon>
                            <span>系统设置</span>
                        </el-menu-item>
                    </el-menu>
                </el-drawer>

                <el-main>
                    <!-- View 1: Dashboard & Basic -->
                    <div v-if="currentView === '1'">
                        <el-row :gutter="20">
                            <el-col :xs="24" :sm="24" :md="12">
                                <el-card class="mb-4">
                                    <template #header>
                                        <div class="card-header">
                                            <span>默认后端</span>
                                            <el-button type="primary" size="small" @click="saveDefaultBackend" :loading="loading">保存</el-button>
                                        </div>
                                    </template>
                                    <el-alert title="当没有匹配的高级规则时，请求将转发到此地址" type="info" :closable="false" class="mb-4" show-icon></el-alert>
                                    <el-input v-model="config.default_backend" placeholder="例如：http://127.0.0.1:6185"></el-input>
                                </el-card>
                            </el-col>
                            <el-col :xs="24" :sm="24" :md="12">
                                <el-card class="mb-4">
                                    <template #header>
                                        <div class="card-header">
                                            <span>状态概览</span>
                                            <el-button type="primary" link @click="fetchConfig"><el-icon><Refresh /></el-icon> 刷新</el-button>
                                        </div>
                                    </template>
                                    <el-descriptions :column="1" border>
                                        <el-descriptions-item label="规则数量">{{ config.rules ? config.rules.length : 0 }}</el-descriptions-item>
                                        <el-descriptions-item label="同步状态">
                                            <el-tag :type="syncStatus.stage === 'complete' ? 'success' : 'warning'">{{ syncStatusMessages[syncStatus.stage] || syncStatus.stage }}</el-tag>
                                        </el-descriptions-item>
                                        <el-descriptions-item label="同步进度">
                                            <el-progress :percentage="syncStatus.progress" :status="syncStatus.stage === 'complete' ? 'success' : ''"></el-progress>
                                        </el-descriptions-item>
                                    </el-descriptions>
                                </el-card>
                            </el-col>
                        </el-row>
                        
                    </div>

                    <!-- View 2: Advanced Rules -->
                    <div v-if="currentView === '2'">
                        <el-card class="mb-4">
                            <template #header>
                                <div class="card-header">
                                    <span>高级规则管理</span>
                                    <div>
                                        <el-button type="success" icon="Plus" @click="openRuleEditor()">添加规则</el-button>
                                        <el-button type="warning" icon="Edit" @click="jsonMode = !jsonMode">{{ jsonMode ? '切换列表视图' : '切换 JSON 模式' }}</el-button>
                                        <el-button type="primary" icon="Check" @click="saveRules" :loading="loading">保存所有更改</el-button>
                                    </div>
                                </div>
                            </template>

                            <!-- JSON Mode -->
                            <div v-if="jsonMode">
                                <el-input
                                    v-model="rulesJson"
                                    type="textarea"
                                    :rows="20"
                                    placeholder="在此输入 JSON 配置..."
                                    style="font-family: monospace;"
                                ></el-input>
                            </div>

                            <!-- List Mode -->
                            <div v-else>
                                <el-table :data="config.rules" style="width: 100%" stripe border empty-text="暂无规则">
                                    <el-table-column prop="priority" label="优先级" width="80" sortable></el-table-column>
                                    <el-table-column prop="id" label="ID" width="120" show-overflow-tooltip></el-table-column>
                                    <el-table-column label="匹配条件" min-width="200">
                                        <template #default="scope">
                                            <div v-if="scope.row.match">
                                                <el-tag v-if="scope.row.match.host" size="small" type="info">Host: {{ scope.row.match.host }}</el-tag>
                                                <el-tag v-if="scope.row.match.path_prefix" size="small" type="warning">Path: {{ scope.row.match.path_prefix }}</el-tag>
                                                <el-tag v-if="scope.row.match.method" size="small">Method: {{ scope.row.match.method }}</el-tag>
                                            </div>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="action" label="动作" width="100">
                                        <template #default="scope">
                                            <el-tag :type="scope.row.action === 'redirect' ? 'warning' : 'success'">{{ scope.row.action }}</el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="目标" min-width="200" show-overflow-tooltip>
                                        <template #default="scope">
                                            <span v-if="scope.row.action === 'proxy'">{{ scope.row.backend }}</span>
                                            <span v-else>{{ scope.row.redirect_to || scope.row.redirect_to_prefix + '...' }}</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="操作" width="150" fixed="right">
                                        <template #default="scope">
                                            <el-button size="small" @click="openRuleEditor(scope.row, scope.$index)">编辑</el-button>
                                            <el-button size="small" type="danger" @click="deleteRule(scope.$index)">删除</el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                        </el-card>
                    </div>

                    <!-- View 3: Rule Tester -->
                    <div v-if="currentView === '3'">
                        <el-row :gutter="20">
                            <el-col :xs="24" :sm="24" :md="12">
                                <el-card class="mb-4">
                                    <template #header>
                                        <div class="card-header"><span>模拟请求</span></div>
                                    </template>
                                    <el-form label-position="top">
                                        <el-form-item label="URL">
                                            <el-input v-model="testReq.url" placeholder="http://example.com/api/v1"></el-input>
                                        </el-form-item>
                                        <el-form-item label="Method">
                                            <el-select v-model="testReq.method">
                                                <el-option value="GET" label="GET"></el-option>
                                                <el-option value="POST" label="POST"></el-option>
                                                <el-option value="PUT" label="PUT"></el-option>
                                                <el-option value="DELETE" label="DELETE"></el-option>
                                            </el-select>
                                        </el-form-item>
                                        <el-form-item label="Referer">
                                            <el-input v-model="testReq.referer" placeholder=""></el-input>
                                        </el-form-item>
                                        <el-button type="primary" @click="runTest">测试匹配</el-button>
                                    </el-form>
                                </el-card>
                            </el-col>
                            <el-col :xs="24" :sm="24" :md="12">
                                <el-card class="mb-4">
                                    <template #header>
                                        <div class="card-header"><span>匹配结果</span></div>
                                    </template>
                                    <div v-if="testResult">
                                        <el-alert
                                            :title="testResult.matched ? '匹配成功' : '无匹配规则'"
                                            :type="testResult.matched ? 'success' : 'info'"
                                            :closable="false"
                                            show-icon
                                            class="mb-4"
                                        ></el-alert>
                                        <el-descriptions :column="1" border>
                                            <el-descriptions-item label="最终后端">{{ testResult.backend }}</el-descriptions-item>
                                            <el-descriptions-item label="匹配规则 ID">{{ testResult.ruleId || '-' }}</el-descriptions-item>
                                            <el-descriptions-item label="动作">{{ testResult.action }}</el-descriptions-item>
                                            <el-descriptions-item label="优先级">{{ testResult.priority }}</el-descriptions-item>
                                        </el-descriptions>
                                    </div>
                                    <div v-else style="color: #666; text-align: center; padding: 20px;">
                                        点击“测试匹配”查看结果
                                    </div>
                                </el-card>
                            </el-col>
                        </el-row>
                    </div>

                    <!-- View 4: Settings -->
                    <div v-if="currentView === '4'">
                        <el-card class="mb-4" style="max-width: 600px; margin: 0 auto;">
                            <template #header>
                                <div class="card-header"><span>修改管理员密码</span></div>
                            </template>
                            <el-form label-position="top">
                                <el-form-item label="当前密码">
                                    <el-input v-model="pwdForm.old" type="password" show-password></el-input>
                                </el-form-item>
                                <el-form-item label="新密码">
                                    <el-input v-model="pwdForm.new" type="password" show-password></el-input>
                                </el-form-item>
                                <el-form-item label="确认新密码">
                                    <el-input v-model="pwdForm.confirm" type="password" show-password></el-input>
                                </el-form-item>
                                <el-button type="primary" @click="changePassword" :loading="loading">修改密码</el-button>
                            </el-form>
                        </el-card>
                    </div>
                </el-main>
            </el-container>
        </el-container>

        <!-- Rule Editor Dialog -->
        <el-dialog v-model="editorVisible" title="编辑规则" width="90%" style="max-width: 800px;">
            <el-form :model="editingRule" label-width="100px">
                <el-tabs v-model="editorTab">
                    <el-tab-pane label="基本信息" name="basic">
                        <el-form-item label="ID">
                            <el-input v-model="editingRule.id" placeholder="可选，用于标识"></el-input>
                        </el-form-item>
                        <el-form-item label="优先级">
                            <el-input-number v-model="editingRule.priority" :min="0"></el-input-number>
                            <div style="font-size: 12px; color: #999;">数字越大优先级越高</div>
                        </el-form-item>
                        <el-form-item label="动作">
                            <el-radio-group v-model="editingRule.action">
                                <el-radio label="proxy">反向代理 (Proxy)</el-radio>
                                <el-radio label="redirect">重定向 (Redirect)</el-radio>
                            </el-radio-group>
                        </el-form-item>
                        <el-form-item label="后端地址" v-if="editingRule.action === 'proxy'">
                            <el-input v-model="editingRule.backend" placeholder="http://127.0.0.1:8080"></el-input>
                        </el-form-item>
                        <template v-if="editingRule.action === 'redirect'">
                            <el-form-item label="重定向目标">
                                <el-input v-model="editingRule.redirect_to" placeholder="完整 URL"></el-input>
                            </el-form-item>
                            <el-form-item label="前缀拼接">
                                <el-input v-model="editingRule.redirect_to_prefix" placeholder="替换 Path 前缀"></el-input>
                            </el-form-item>
                        </template>
                    </el-tab-pane>
                    <el-tab-pane label="匹配条件" name="match">
                        <el-form-item label="Host">
                            <el-input v-model="editingRule.match.host" placeholder="example.com"></el-input>
                        </el-form-item>
                        <el-form-item label="Path 前缀">
                            <el-input v-model="editingRule.match.path_prefix" placeholder="/api/"></el-input>
                        </el-form-item>
                        <el-form-item label="Path 精确">
                            <el-input v-model="editingRule.match.path_equal" placeholder="/exact/path"></el-input>
                        </el-form-item>
                        <el-form-item label="Method">
                            <el-select v-model="editingRule.match.method" clearable placeholder="任意">
                                <el-option value="GET" label="GET"></el-option>
                                <el-option value="POST" label="POST"></el-option>
                                <el-option value="PUT" label="PUT"></el-option>
                                <el-option value="DELETE" label="DELETE"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-tab-pane>
                </el-tabs>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="editorVisible = false">取消</el-button>
                    <el-button type="primary" @click="confirmEditRule">确定</el-button>
                </span>
            </template>
        </el-dialog>
    </div>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>

    <script>
        const { createApp, ref, onMounted, reactive, computed, watch } = Vue;

        const app = createApp({
            setup() {
                const isAuthenticated = ref(false);
                const password = ref('');
                const loading = ref(false);
                const currentView = ref('1');
                const drawerVisible = ref(false);
                
                const config = reactive({
                    default_backend: '',
                    rules: []
                });
                
                const syncStatus = reactive({
                    stage: 'unknown',
                    progress: 0
                });
                const syncStatusMessages = {
                    'starting': '启动中',
                    'git': 'Git 同步',
                    'linking': '链接文件',
                    'lfs_download': '下载 LFS',
                    'complete': '完成'
                };

                // Rule Editor
                const jsonMode = ref(false);
                const rulesJson = ref('');
                const editorVisible = ref(false);
                const editorTab = ref('basic');
                const editingIndex = ref(-1);
                const editingRule = reactive({
                    id: '', priority: 0, action: 'proxy', backend: '', 
                    redirect_to: '', redirect_to_prefix: '',
                    match: { host: '', path_prefix: '', path_equal: '', method: '' }
                });

                // Rule Tester
                const testReq = reactive({ url: '', method: 'GET', referer: '' });
                const testResult = ref(null);

                // Password Change
                const pwdForm = reactive({ old: '', new: '', confirm: '' });

                // Auth Logic
                const checkAuth = () => {
                    const saved = localStorage.getItem('routeAdminPassword');
                    if (saved) {
                        password.value = saved;
                        isAuthenticated.value = true;
                        fetchConfig();
                        startSyncPoll();
                    }
                };

                const login = () => {
                    if (password.value) {
                        localStorage.setItem('routeAdminPassword', password.value);
                        isAuthenticated.value = true;
                        fetchConfig();
                        startSyncPoll();
                    }
                };

                const logout = () => {
                    localStorage.removeItem('routeAdminPassword');
                    isAuthenticated.value = false;
                    password.value = '';
                };

                const headers = () => ({ 'X-Admin-Password': password.value });

                // API Calls
                const fetchConfig = async () => {
                    try {
                        const res = await fetch('/admin/routes.json', { headers: headers() });
                        if (res.status === 403) {
                            ElementPlus.ElMessage.error('密码错误或已过期');
                            logout();
                            return;
                        }
                        const data = await res.json();
                        config.default_backend = data.default_backend || '';
                        config.rules = data.rules || [];
                        rulesJson.value = JSON.stringify(config.rules, null, 2);
                    } catch (e) {
                        ElementPlus.ElMessage.error('加载配置失败: ' + e.message);
                    }
                };

                const saveConfig = async (newConfig) => {
                    loading.value = true;
                    try {
                        const res = await fetch('/admin/routes.json', {
                            method: 'POST',
                            headers: Object.assign({ 'Content-Type': 'application/json' }, headers()),
                            body: JSON.stringify(newConfig)
                        });
                        if (!res.ok) throw new Error(await res.text());
                        ElementPlus.ElMessage.success('保存成功');
                        await fetchConfig();
                    } catch (e) {
                        ElementPlus.ElMessage.error('保存失败: ' + e.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const saveDefaultBackend = () => {
                    saveConfig({ default_backend: config.default_backend });
                };

                const saveRules = () => {
                    let rulesToSave = config.rules;
                    if (jsonMode.value) {
                        try {
                            rulesToSave = JSON.parse(rulesJson.value);
                        } catch (e) {
                            ElementPlus.ElMessage.error('JSON 格式错误');
                            return;
                        }
                    }
                    saveConfig({ rules: rulesToSave });
                };

                // Rule Editor Logic
                const openRuleEditor = (rule, index) => {
                    editingIndex.value = index !== undefined ? index : -1;
                    const src = rule || { priority: 0, action: 'proxy', match: {} };
                    // Deep copy to avoid direct mutation
                    Object.assign(editingRule, JSON.parse(JSON.stringify(src)));
                    if (!editingRule.match) editingRule.match = {};
                    editorVisible.value = true;
                };

                const confirmEditRule = () => {
                    // Clean up empty fields
                    const r = JSON.parse(JSON.stringify(editingRule));
                    if (!r.match.host) delete r.match.host;
                    if (!r.match.path_prefix) delete r.match.path_prefix;
                    if (!r.match.path_equal) delete r.match.path_equal;
                    if (!r.match.method) delete r.match.method;
                    
                    if (editingIndex.value > -1) {
                        config.rules[editingIndex.value] = r;
                    } else {
                        config.rules.push(r);
                    }
                    rulesJson.value = JSON.stringify(config.rules, null, 2);
                    editorVisible.value = false;
                };

                const deleteRule = (index) => {
                    config.rules.splice(index, 1);
                    rulesJson.value = JSON.stringify(config.rules, null, 2);
                };

                // Rule Tester Logic
                const runTest = () => {
                    try {
                        const urlObj = new URL(testReq.url);
                        const path = urlObj.pathname;
                        const host = urlObj.hostname;
                        
                        let bestRule = null;
                        let bestPri = -1, bestPL = -1;

                        config.rules.forEach(r => {
                            const m = r.match || {};
                            if (m.host && m.host !== host) return;
                            if (m.path_equal && m.path_equal !== path) return;
                            if (m.path_prefix && !path.startsWith(m.path_prefix)) return;
                            if (m.method && m.method !== testReq.method) return;

                            const pri = r.priority || 0;
                            const pl = m.path_prefix ? m.path_prefix.length : 0;

                            if (pri > bestPri || (pri === bestPri && pl > bestPL)) {
                                bestPri = pri;
                                bestPL = pl;
                                bestRule = r;
                            }
                        });

                        if (bestRule) {
                            testResult.value = {
                                matched: true,
                                ruleId: bestRule.id,
                                action: bestRule.action,
                                backend: bestRule.action === 'proxy' ? bestRule.backend : (bestRule.redirect_to || 'Redirect'),
                                priority: bestRule.priority
                            };
                        } else {
                            testResult.value = {
                                matched: false,
                                backend: config.default_backend || 'Default (未设置)',
                                action: 'proxy',
                                priority: 0
                            };
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('无效的 URL');
                    }
                };

                // Password Change
                const changePassword = async () => {
                    if (pwdForm.new !== pwdForm.confirm) {
                        ElementPlus.ElMessage.error('两次输入的新密码不一致');
                        return;
                    }
                    loading.value = true;
                    try {
                        const res = await fetch('/admin/password', {
                            method: 'POST',
                            headers: Object.assign({ 'Content-Type': 'application/json', 'X-Admin-Password': pwdForm.old }, headers()), // Use old password for auth
                            body: JSON.stringify({ new_password: pwdForm.new })
                        });
                        if (!res.ok) throw new Error(await res.text());
                        ElementPlus.ElMessage.success('密码修改成功，请重新登录');
                        logout();
                    } catch (e) {
                        ElementPlus.ElMessage.error('修改失败: ' + e.message);
                    } finally {
                        loading.value = false;
                    }
                };

                // Sync Status Polling
                const startSyncPoll = () => {
                    const poll = async () => {
                        if (!isAuthenticated.value) return;
                        try {
                            const res = await fetch('/api/sync-progress');
                            const data = await res.json();
                            Object.assign(syncStatus, data);
                            if (data.stage !== 'complete') {
                                setTimeout(poll, 2000);
                            }
                        } catch (e) {
                            // ignore
                        }
                    };
                    poll();
                };

                const handleMenuSelect = (index) => {
                    currentView.value = index;
                    drawerVisible.value = false;
                };

                onMounted(() => {
                    checkAuth();
                });

                return {
                    isAuthenticated, password, loading, login, logout,
                    currentView, drawerVisible, handleMenuSelect,
                    config, syncStatus, syncStatusMessages, fetchConfig,
                    saveDefaultBackend, saveRules,
                    jsonMode, rulesJson, editorVisible, editorTab, editingRule, openRuleEditor, confirmEditRule, deleteRule,
                    testReq, testResult, runTest,
                    pwdForm, changePassword
                };
            }
        });

        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component);
        }

        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>
